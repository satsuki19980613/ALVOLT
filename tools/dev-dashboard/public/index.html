<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALVOLT OPS</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<div class="container">
    <header>
        <h1 class="neon-title">ALVOLT OPS</h1>
        <div class="status-panel">
            <div>BRANCH: <span id="branchName" class="status-val">Loading...</span></div>
            <div>STATUS: <span id="gitStatus" class="status-val">Loading...</span></div>
        </div>
    </header>

    <div class="panel" id="panel-audit">
        <div class="panel-header">01. AI AUDIT (Full Context)</div>
        <p>Gemini AIãŒã€Œå…¨ã‚³ãƒ¼ãƒ‰ã€ã€Œæ§‹é€ ã€ã€Œãƒ«ãƒ¼ãƒ«ã€ã€Œå·®åˆ†ã€ã‚’è§£æã—ã€å“è³ªã‚’å¯©æŸ»ã—ã¾ã™ã€‚</p>
        <div class="action-area">
            <button class="btn btn-cyan" onclick="runAudit()">AIå¯©æŸ»ã‚’å®Ÿè¡Œ</button>
        </div>
        <div id="auditLog" class="logs hidden markdown-body"></div>
    </div>

    <div class="panel disabled" id="panel-deploy-test">
        <div class="panel-header">02. DEPLOY TO STAGING</div>
        <p>å¯©æŸ»ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãƒ†ã‚¹ãƒˆç’°å¢ƒã¸åæ˜ ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="text" id="commitMsg" placeholder="ä¾‹: ãƒã‚°ä¿®æ­£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„">
        <div class="action-area">
            <button class="btn btn-yellow" onclick="deployTest()">ãƒ†ã‚¹ãƒˆç’°å¢ƒã¸åæ˜ </button>
        </div>
        <div id="deployTestLog" class="logs hidden"></div>
    </div>

    <div class="panel disabled" id="panel-deploy-prod">
        <div class="panel-header">03. RELEASE TO PRODUCTION</div>
        <p>ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ç¢ºèªå®Œäº†å¾Œã€æœ¬ç•ªç’°å¢ƒã¸ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã™ã€‚</p>
        <div class="action-area">
            <button class="btn btn-magenta" onclick="deployProd()">æœ¬ç•ªç’°å¢ƒã¸åæ˜ </button>
        </div>
        <div id="deployProdLog" class="logs hidden"></div>
    </div>
</div>

<script>
    // --- çŠ¶æ…‹ç®¡ç† ---
    async function loadStatus() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('branchName').innerText = data.branch;
            document.getElementById('gitStatus').innerText = data.status || "Clean";
        } catch(e) { console.error(e); }
    }

    // --- 01. AIå¯©æŸ» ---
    async function runAudit() {
        const logDiv = document.getElementById('auditLog');
        logDiv.classList.remove('hidden');
        logDiv.innerHTML = '<span class="blink">AI is thinking... (Reading full codebase)</span>';

        try {
            const res = await fetch('/api/audit', { method: 'POST' });
            const data = await res.json();

            // â˜… Markdownã‚’HTMLã«å¤‰æ›ã—ã¦è¡¨ç¤º
            logDiv.innerHTML = marked.parse(data.aiResponse);

            // "PASS" ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
            if (data.aiResponse.includes("PASS")) {
                document.getElementById('panel-deploy-test').classList.remove('disabled');
                document.getElementById('panel-deploy-test').scrollIntoView({ behavior: 'smooth' });
            }
        } catch (e) {
            logDiv.innerText = "Error: " + e;
        }
    }

    // --- 02. ãƒ‡ãƒ—ãƒ­ã‚¤ (Staging) ---
    async function deployTest() {
        const msg = document.getElementById('commitMsg').value;
        if(!msg) return alert("ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        const logDiv = document.getElementById('deployTestLog');
        logDiv.classList.remove('hidden');
        logDiv.innerText = "Deploying to Staging... (Please wait)";

        try {
            const res = await fetch('/api/deploy-test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            if(data.error) throw data.error;

            logDiv.innerText = `âœ… Success! Deployed to Staging.\nBranch: ${data.branch}`;
            document.getElementById('panel-deploy-prod').classList.remove('disabled');
        } catch(e) {
            logDiv.innerText = "âŒ Error: " + e;
        }
    }

    // --- 03. ãƒ‡ãƒ—ãƒ­ã‚¤ (Prod) ---
    async function deployProd() {
        if(!confirm("æœ¬ç•ªç’°å¢ƒã¸åæ˜ ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;

        const logDiv = document.getElementById('deployProdLog');
        logDiv.classList.remove('hidden');
        logDiv.innerText = "Releasing to Production... (Processing)";

        try {
            const res = await fetch('/api/deploy-prod', { method: 'POST' });
            const data = await res.json();
            if(data.error) throw data.error;

            logDiv.innerText = `ğŸ‰ RELEASE COMPLETE!\nTag: ${data.tag}`;
        } catch(e) {
            logDiv.innerText = "âŒ Error: " + e;
        }
    }

    // åˆæœŸåŒ–
    loadStatus();
</script>
</body>
</html>